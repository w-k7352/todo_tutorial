# 詳細設計書 v1.0 — ToDo管理Webアプリ

## 1. 概要

本ドキュメントは、「基本設計書 v1.0」を基に、ToDo管理Webアプリの各コンポーネントと関数の詳細な仕様を定義する。

## 2. ファイル構成

```
/
├── index.html
├── style.css
├── app.js
├── view.js
├── taskRepository.js
└── utils.js
```

## 3. HTML構造 (`index.html`)

主要な要素に `id` を付与し、JavaScriptから容易にアクセスできるようにする。

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- ... メタデータ ... -->
    <title>ToDo App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>ToDoリスト</h1>
        <div id="task-counters">
            <span>未着手: <span id="counter-todo">0</span></span>
            <span>進行中: <span id="counter-doing">0</span></span>
            <span>完了: <span id="counter-done">0</span></span>
        </div>
    </header>

    <main>
        <!-- 新規登録フォーム -->
        <section id="add-task-section">
            <form id="add-task-form">
                <input type="text" id="task-title-input" placeholder="タスクのタイトル" required>
                <input type="date" id="task-due-date-input">
                <input type="text" id="task-tags-input" placeholder="タグ (カンマ区切り)">
                <button type="submit">追加</button>
            </form>
        </section>

        <!-- コントロールエリア -->
        <section id="controls-section">
            <input type="search" id="search-keyword" placeholder="キーワード検索">
            <input type="text" id="filter-tag" placeholder="タグで絞り込み">
            <input type="date" id="filter-due-start" title="期限開始日">
            <input type="date" id="filter-due-end" title="期限終了日">
            <select id="filter-status">
                <option value="all">全ステータス</option>
                <option value="todo">未着手</option>
                <option value="doing">進行中</option>
                <option value="done">完了</option>
            </select>
            <select id="sort-by">
                <option value="created_at_desc">作成日(新しい順)</option>
                <option value="created_at_asc">作成日(古い順)</option>
                <option value="due_date_asc">期限(昇順)</option>
                <option value="title_asc">タイトル(A-Z)</option>
            </select>
            <button id="clear-filters-button">フィルタ解除</button>
            <button id="export-csv-button">CSVエクスポート</button>
        </section>

        <!-- タスク一覧 -->
        <section id="task-list-section">
            <table id="task-table">
                <thead>
                    <tr>
                        <th>完了</th>
                        <th>タイトル</th>
                        <th>ステータス</th>
                        <th>期限</th>
                        <th>タグ</th>
                        <th>作成/更新日時</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="task-list-body">
                    <!-- タスク行はJavaScriptで動的に生成 -->
                </tbody>
            </table>
        </section>
    </main>

    <!-- ... scriptタグ ... -->
    <script src="utils.js"></script>
    <script src="taskRepository.js"></script>
    <script src="view.js"></script>
    <script src="app.js"></script>
</body>
</html>
```

## 4. CSS設計 (`style.css`)

-   **クラス設計**: BEM（Block, Element, Modifier）を参考に、予測しやすいクラス名を設計する。
    -   例: `.task-item`, `.task-item--done`, `.task-item__title`
-   **色分け**:
    -   ステータスバッジ: `todo` (灰色), `doing` (青系), `done` (緑系)
    -   期限バッジ: `overdue` (赤系), `today` (オレンジ系), `future` (無色 or 緑系)
-   **レスポンシブ**:
    -   `@media (max-width: 768px)` をブレークポイントとし、テーブル表示をカード表示に切り替えるなど、モバイル向けレイアウトを定義する。

## 5. JavaScriptモジュール詳細

### 5.1. `taskRepository.js`

`localStorage` との通信を担当する。

-   `const STORAGE_KEY = 'todo_tasks_v1';`
-   `getAllTasks()`: `localStorage`から全タスクを取得し、パースして返す。データがなければ空配列を返す。
-   `saveAllTasks(tasks)`: タスクの配列をJSON文字列化し、`localStorage`に保存する。
-   `addTask(task)`: 新しいタスクを既存のタスク配列に追加して保存する。
-   `updateTask(updatedTask)`: `id` をキーにタスクを検索し、内容を更新して保存する。
-   `deleteTask(taskId)`: `id` をキーにタスクを配列からフィルタリングで除外し、保存する。

### 5.2. `view.js`

DOM操作のみを担当する。状態は持たない。

-   `elements`: 主要なDOM要素への参照を保持するオブジェクト。
-   `renderTasks(tasks)`:
    -   `task-list-body` の中身を空にする。
    -   `tasks` 配列をループし、各タスクに対応する `<tr>` 要素を生成する。
        -   各行には `data-task-id="${task.id}"` を付与する。
        -   完了状態に応じて `task-item--done` クラスを付与する。
        -   期限に応じて `due-badge--overdue` などのクラスを付与する。
    -   生成したHTMLを `innerHTML` に一括で設定する。
-   `updateCounters(tasks)`:
    -   `tasks` 配列からステータスごとの件数を集計し、`counter-todo` などの要素のテキストを更新する。
-   `clearForm()`: 新規登録フォームの入力欄をクリアする。
-   `getFormValues()`: 新規登録フォームの現在の入力値をオブジェクトとして返す。
-   `showFeedback(message, type)`: 画面上部にフィードバックメッセージ（例: "保存しました"）を短時間表示する。

### 5.3. `utils.js`

汎用的なヘルパー関数。

-   `generateUUID()`: `crypto.randomUUID()` または互換性のある代替手段で一意のIDを生成する。
-   `formatDate(isoString)`: ISO 8601形式の日付文字列を `YYYY-MM-DD` 形式に変換する。
-   `escapeCSV(value)`: CSVの値にカンマやダブルクオートが含まれる場合に、RFC 4180に準拠してエスケープする。
-   `getCurrentISOTime()`: 現在時刻のISO 8601文字列を返す。

### 5.4. `app.js`

アプリケーションのロジックと状態管理を担当する。

-   `state`:
    -   `allTasks`: `taskRepository` から取得した全てのタスクのキャッシュ。
    -   `filter`: 現在のフィルタ条件 (`keyword`, `status` など)。
    -   `sort`: 現在のソート条件。
-   `init()`:
    -   `DOMContentLoaded` イベントで発火。
    -   `taskRepository` からタスクをロードし `state` に保存。
    -   主要なDOM要素にイベントリスナーを登録する (`add-task-form` の `submit`、コントロール要素の `change`、タスク一覧の `click` など)。
    -   `render()` を呼び出して初期描画を行う。
-   `render()`:
    -   `state` の `allTasks` を現在のフィルタ・ソート条件で加工する。
    -   加工後のタスクリストを `view.renderTasks()` に渡して描画する。
    -   `view.updateCounters()` を呼び出してカウンタを更新する。
-   **イベントハンドラ**:
    -   `handleAddTask(e)`: フォーム送信を処理。`view.getFormValues()` で値を取得し、`id` やタイムスタンプを付与して `taskRepository.addTask()` を呼び出し、再描画する。
    -   `handleTaskListClick(e)`:
        -   イベントデリゲーションを利用。クリックされた要素 (`e.target`) を判別。
        -   **完了トグル**: チェックボックスがクリックされた場合、対応するタスクの `status` を変更し、`taskRepository.updateTask()` を呼び出す。
        -   **削除**: 削除ボタンの場合、`confirm()` で確認後、`taskRepository.deleteTask()` を呼び出す。
        -   **編集**: 編集ボタンの場合、モーダルUIなどを表示して更新処理を行う。
    -   `handleFilterChange()` / `handleSortChange()`: `state` のフィルタ/ソート条件を更新し、`render()` を呼び出す。
    -   `handleExportCSV()`: `state.allTasks` をCSV文字列に変換し、ダウンロードリンクを生成してクリックさせる。

